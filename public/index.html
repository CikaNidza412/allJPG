<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Uncle Nick‚Äôs Network</title>
  <meta name="description" content="Convert images to JPG, resize & compress ‚Äî in your browser. No uploads." />

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EBXM5LV7KM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-EBXM5LV7KM', { anonymize_ip: true });
  </script>

  <style>
    :root{
      color-scheme: light;
      --bg:#f6f7fb; --card:#fff; --shadow:0 18px 45px rgba(0,0,0,.08);
      --text:#1f2937; --muted:#6b7280;
      --drop:#cfe6ff; --dropBorder:#7cb4ff;
      --btn:#cbd5e1; --btnText:#ffffff;
      --line:#e5e7eb;
      --danger:#ef4444;
      --optBg:#ffffff;
      --optBorder:#e5e7eb;
      --optShadow:0 6px 18px rgba(0,0,0,.04);
      --disabledBg:#f3f4f6;
      --disabledText:#9ca3af;

      /* help bubble */
      --helpBg:#ffffff;
      --helpBorder:#e5e7eb;
      --helpShadow:0 18px 45px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
      min-height:100vh; display:flex; align-items:center; justify-content:center;
      padding:28px 18px;
    }
    .wrap{width:min(980px,100%); display:flex; flex-direction:column; align-items:center; gap:12px;}
    .card{width:min(860px,100%); background:var(--card); border-radius:18px; box-shadow:var(--shadow); padding:26px 26px 18px;}
    .top{display:flex; flex-direction:column; align-items:center; text-align:center; gap:10px; margin-bottom:14px;}

    /* LOGO CIRCLE */
    .logo{
      width:74px; height:74px; border-radius:999px;
      background:#eef2ff; border:3px solid rgba(59,130,246,.18);
      display:grid; place-items:center; overflow:hidden;
    }
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover; /* ako ≈æeli≈° da se vidi ceo logo bez seƒçenja: stavi "contain" */
      display:block;
    }

    h1{margin:0; font-size:22px; font-weight:500; letter-spacing:.2px;}
    .sub{margin:0; font-size:13px; color:var(--muted)}

    .drop{
      margin-top:10px; background:var(--drop);
      border:2px dashed var(--dropBorder); border-radius:14px; padding:22px 18px; text-align:center;
      cursor:pointer; user-select:none;
    }
    .drop .icon{font-size:34px; line-height:1; margin-bottom:8px;}
    .drop .title{margin:0; font-size:16px; color:rgba(37,99,235,.75); font-weight:600;}
    .drop .hint{margin:6px 0 0; font-size:12px; color:rgba(17,24,39,.65)}

    .controls{margin-top:14px;}
    .panel{border:1px solid var(--line); border-radius:14px; padding:12px; background:#fff;}
    .panelHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .panel h2{
      margin:0;
      font-size:15px;
      font-weight:700;
      letter-spacing:.2px;
      color:#374151;
    }

    input[type="number"], input[type="text"], select{
      width:100%; padding:10px 10px; border:1px solid var(--line); border-radius:12px; outline:none; font-size:14px;
      background:#fff;
    }
    input[type="range"]{width:100%;}
    .muted{color:var(--muted)}

    .grid3{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .grid3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .opt{
      position:relative;
      border:1px solid var(--optBorder);
      border-radius:14px;
      background:var(--optBg);
      padding:12px;
      box-shadow: var(--optShadow);

      /* keep layout stable; help is overlay */
      padding-bottom:12px;
    }
    .optTitleRow{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      margin-bottom:8px;
    }

    /* OPTION TITLE now matches drop title feel (but black) */
    .optTitle{
      font-size:16px;         /* like drop title */
      font-weight:600;        /* like drop title */
      color:#111827;          /* black-ish */
      letter-spacing:0;
      line-height:1.25;
    }

    .infoDot{
      width:18px; height:18px; border-radius:999px;
      border:1px solid var(--line);
      display:grid; place-items:center;
      color:#6b7280;
      font-size:12px;
      background:#fff;
      flex:0 0 auto;
      cursor:pointer;
      user-select:none;
    }
    .infoDot:active{ transform: scale(.98); }

    /* HELP is now an overlay bubble; does not push layout */
    .help{
      position:absolute;
      left:12px;
      right:12px;
      top:100%;
      margin-top:10px;

      background:var(--helpBg);
      border:1px solid var(--helpBorder);
      border-radius:14px;
      box-shadow:var(--helpShadow);
      padding:10px 12px;

      font-size:12px;
      color:#6b7280;
      line-height:1.35;

      opacity:0;
      transform: translateY(-6px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:30;
    }
    /* little arrow */
    .help::before{
      content:"";
      position:absolute;
      top:-7px;
      left:18px;
      width:12px; height:12px;
      background:var(--helpBg);
      border-left:1px solid var(--helpBorder);
      border-top:1px solid var(--helpBorder);
      transform: rotate(45deg);
    }

    /* Desktop hover/focus */
    @media (hover:hover) and (pointer:fine){
      .opt:hover .help,
      .opt:focus-within .help{
        opacity:1;
        transform: translateY(0);
        pointer-events:auto;
      }
    }
    /* Mobile/manual toggle */
    .opt.show-help .help{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
    }

    .optionsSpacer{
      height:56px;
    }
    @media (min-width:900px){
      .optionsSpacer{ height:44px; }
    }

    /* Disabled max fields look */
    .disabledField input[disabled]{
      background: var(--disabledBg);
      color: var(--disabledText);
      cursor:not-allowed;
    }
    .disabledField input[disabled]::placeholder{ color:#b6bcc6; }
    .disabledNote{
      margin-top:8px;
      font-size:12px;
      color:#9ca3af;
      line-height:1.35;
      display:none;
    }
    .opt.disabledField .disabledNote{ display:block; }

    .toggle{
      display:flex; align-items:center; gap:10px;
      user-select:none;
      font-size:12px;
      color:#374151;
      font-weight:650;
      letter-spacing:.15px;
    }
    .switch{
      width:42px; height:24px;
      background:#e5e7eb;
      border-radius:999px;
      position:relative;
      border:1px solid var(--line);
      cursor:pointer;
      flex:0 0 auto;
    }
    .knob{
      position:absolute; top:2px; left:2px;
      width:20px; height:20px; border-radius:999px;
      background:#fff;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      transition:transform .18s ease;
    }
    .switch.on{ background:#bfdbfe; }
    .switch.on .knob{ transform: translateX(18px); }

    .btn{
      width:100%; border:0; border-radius:12px; padding:14px 16px;
      background:var(--btn); color:var(--btnText); font-size:15px; font-weight:800; cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .mini-actions{display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap;}
    .linkbtn{
      border:1px solid var(--line); background:#fff; border-radius:999px;
      padding:8px 12px; font-weight:700; cursor:pointer; color:#111827;
    }
    .dangerbtn{
      border:1px solid rgba(239,68,68,.35);
      background:#fff;
      color:#b91c1c;
      border-radius:999px;
      padding:8px 12px;
      font-weight:800;
      cursor:pointer;
    }
    .status{margin-top:10px; font-size:12px; color:var(--muted); text-align:center;}

    .progressWrap{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      display:none;
    }
    .progressBar{
      height:12px;
      width:0%;
      background: linear-gradient(90deg, #7cb4ff, #60a5fa, #93c5fd);
      transition: width .15s ease;
    }
    .progressMeta{
      display:flex; justify-content:space-between; gap:10px;
      font-size:12px; color:var(--muted);
      margin-top:8px;
      display:none;
    }

    .table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--line); margin-top:14px; display:none;}
    .table th, .table td{padding:10px 10px; font-size:13px; border-bottom:1px solid #eef2f7; vertical-align:middle;}
    .table th{background:#f8fafc; text-align:left; color:#374151; font-weight:700;}
    .right{text-align:right;}
    .sr{font-variant-numeric: tabular-nums;}

    footer{width:min(860px,100%); text-align:center; color:var(--muted); font-size:12px; line-height:1.45; padding:6px 10px 0;}
    .footer-strong{color:#374151; font-weight:700;}

    .advanced{ display:none; margin-top:12px; }
    .advanced.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="logo" aria-label="Uncle Nick logo">
          <!-- ‚úÖ NEW: logo.png -->
          <img src="/assets/logo.png" alt="Uncle Nick‚Äôs Network ‚Äî alljpg.xyz" />
        </div>

        <h1>All JPG - convert, resize & compress</h1>
        <p class="sub">Uncle Nick‚Äôs Network ‚Äî Convert to JPG, resize & compress (no uploads).</p>
      </div>

      <div class="drop" id="drop">
        <div class="icon">üìÅ</div>
        <p class="title">Drop images here or click to choose</p>
        <p class="hint">In-browser: JPG/PNG/WEBP/GIF/BMP (HEIC beta: may fail depending on browser)</p>
        <input id="file" type="file" accept="image/*,.heic,.heif" multiple hidden />
      </div>

      <div class="controls">
        <div class="panel">
          <div class="panelHeader">
            <h2>Settings</h2>

            <div class="toggle" id="advToggle">
              <span>Advanced mode</span>
              <div class="switch" id="advSwitch" role="switch" aria-checked="false" tabindex="0">
                <div class="knob"></div>
              </div>
            </div>
          </div>

          <!-- SIMPLE -->
          <div class="grid3" id="simpleGrid">
            <div class="opt" data-help>
              <div class="optTitleRow">
                <div class="optTitle">Target file size (KB) ‚Äî ‚ÄúMake it under‚Äù</div>
                <div class="infoDot" role="button" aria-label="Help">i</div>
              </div>
              <input id="targetKB" type="number" min="0" placeholder="e.g. 300" />
              <div class="help">
                If set, the converter will reduce JPEG quality until the result is under this size (down to ~30%).
              </div>
            </div>

            <div class="opt" data-help>
              <div class="optTitleRow">
                <div class="optTitle">Resize mode</div>
                <div class="infoDot" role="button" aria-label="Help">i</div>
              </div>
              <select id="resizeMode">
                <option value="none">No resize</option>
                <option value="fit">Fit within (keep aspect)</option>
              </select>
              <div class="help">
                ‚ÄúFit within‚Äù scales down to stay inside Max width/height and keeps aspect ratio. It never upscales.
              </div>
            </div>

            <div class="opt disabledField" data-help id="maxBox">
              <div class="optTitleRow">
                <div class="optTitle">Max width / height (px)</div>
                <div class="infoDot" role="button" aria-label="Help">i</div>
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input id="maxW" type="number" min="1" placeholder="e.g. 1920" disabled />
                <input id="maxH" type="number" min="1" placeholder="e.g. 1080" disabled />
              </div>
              <div class="disabledNote">Select ‚ÄúFit within‚Äù to enable these fields.</div>
              <div class="help">
                Only used when Resize mode is ‚ÄúFit within‚Äù. Leave empty to skip resizing.
              </div>
            </div>
          </div>

          <div class="optionsSpacer" aria-hidden="true"></div>

          <!-- ADVANCED -->
          <div class="advanced" id="advanced">
            <div class="grid3">
              <div class="opt" data-help>
                <div class="optTitleRow">
                  <div class="optTitle">Quality (<span id="qLabel">85</span>%)</div>
                  <div class="infoDot" role="button" aria-label="Help">i</div>
                </div>
                <input id="quality" type="range" min="30" max="95" value="85" />
                <div class="help">
                  Controls JPEG compression. If Target file size is set, this is used as the starting point and may be reduced.
                </div>
              </div>

              <div class="opt" data-help>
                <div class="optTitleRow">
                  <div class="optTitle">Filename pattern</div>
                  <div class="infoDot" role="button" aria-label="Help">i</div>
                </div>
                <select id="nameMode">
                  <option value="keep">Keep original name</option>
                  <option value="suffix">Add ‚Äú-jpg‚Äù suffix</option>
                  <option value="alljpg">Use ‚Äúalljpg-###.jpg‚Äù</option>
                </select>
                <div class="help">
                  Sets the output naming rule for downloads and ZIP.
                </div>
              </div>

              <div class="opt" data-help>
                <div class="optTitleRow">
                  <div class="optTitle">Background for transparency</div>
                  <div class="infoDot" role="button" aria-label="Help">i</div>
                </div>
                <select id="bg">
                  <option value="white">White</option>
                  <option value="black">Black</option>
                  <option value="custom">Custom‚Ä¶</option>
                </select>
                <div style="margin-top:8px; display:none;" id="bgCustomWrap">
                  <input id="bgCustom" type="text" value="#ffffff" placeholder="#ffffff" />
                </div>
                <div class="help">
                  PNG/WebP transparency needs a background when converting to JPG. Choose white/black/custom.
                </div>
              </div>
            </div>

            <div class="optionsSpacer" aria-hidden="true"></div>
          </div>

          <div style="margin-top:12px;">
            <button class="btn" id="convert" disabled>Convert selected images</button>

            <div class="progressWrap" id="progressWrap">
              <div class="progressBar" id="progressBar"></div>
            </div>
            <div class="progressMeta" id="progressMeta">
              <div id="progressLeft">0 / 0</div>
              <div id="progressRight">0%</div>
            </div>

            <div class="mini-actions">
              <button class="linkbtn" id="downloadZip" disabled>Download ZIP</button>
              <button class="linkbtn" id="clear" disabled>Clear</button>
            </div>
            <div class="status" id="status">Ready.</div>
          </div>
        </div>
      </div>

      <table class="table" id="table">
        <thead>
          <tr>
            <th>File</th>
            <th class="right">Original</th>
            <th class="right">Result</th>
            <th class="right">Action</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      <div class="footer-strong">¬© 2026 Uncle Nick‚Äôs Network</div>
      Privacy: No logs, no tracking (server-side). This tool processes files locally in your browser.
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
  const $ = (id) => document.getElementById(id);

  const state = {
    files: [],
    results: [],
    worker: null,
    busy: false,
    advanced: false
  };

  // Help toggles (mobile ‚Äúi‚Äù tap)
  function closeAllHelp(exceptOpt){
    document.querySelectorAll(".opt.show-help").forEach(opt => {
      if (opt !== exceptOpt) opt.classList.remove("show-help");
    });
  }

  function initHelp(){
    document.querySelectorAll(".opt[data-help] .infoDot").forEach(dot => {
      dot.addEventListener("click", (e) => {
        e.stopPropagation();
        const opt = dot.closest(".opt");
        const willShow = !opt.classList.contains("show-help");
        closeAllHelp(opt);
        opt.classList.toggle("show-help", willShow);
      });
    });

    // tap outside closes help on mobile
    document.addEventListener("click", () => closeAllHelp(null));
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeAllHelp(null); });
  }

  function fmtBytes(bytes){
    if (!Number.isFinite(bytes)) return "‚Äî";
    const kb = bytes/1024;
    if (kb < 1024) return `${kb.toFixed(1)} KB`;
    return `${(kb/1024).toFixed(2)} MB`;
  }

  function setStatus(msg){ $("status").textContent = msg; }

  function showProgress(show){
    $("progressWrap").style.display = show ? "block" : "none";
    $("progressMeta").style.display = show ? "flex" : "none";
    if (!show){
      $("progressBar").style.width = "0%";
      $("progressLeft").textContent = "0 / 0";
      $("progressRight").textContent = "0%";
    }
  }

  function setProgress(done, total){
    const pct = total ? Math.round((done/total)*100) : 0;
    $("progressBar").style.width = `${pct}%`;
    $("progressLeft").textContent = `${done} / ${total}`;
    $("progressRight").textContent = `${pct}%`;
  }

  function bgColor(){
    const mode = $("bg").value;
    if (mode === "white") return "#ffffff";
    if (mode === "black") return "#000000";
    return ($("bgCustom").value || "#ffffff").trim();
  }

  function safeBaseName(filename){
    return filename.replace(/\.[^.]+$/, "").replace(/[^\w\-]+/g, "_").slice(0, 80);
  }

  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function renderTable(){
    const tbody = $("tbody");
    tbody.innerHTML = "";
    $("table").style.display = state.files.length ? "table" : "none";

    state.files.forEach((f, idx) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = f.name;

      const tdOrig = document.createElement("td");
      tdOrig.className = "right sr";
      tdOrig.textContent = fmtBytes(f.size);

      const tdRes = document.createElement("td");
      tdRes.className = "right sr";
      const res = state.results[idx];
      tdRes.textContent = res ? fmtBytes(res.size) : "‚Äî";

      const tdAct = document.createElement("td");
      tdAct.className = "right";

      const wrap = document.createElement("div");
      wrap.style.display = "inline-flex";
      wrap.style.gap = "8px";
      wrap.style.flexWrap = "wrap";
      wrap.style.justifyContent = "flex-end";

      if (res){
        const dl = document.createElement("button");
        dl.className = "linkbtn";
        dl.textContent = "Download";
        dl.addEventListener("click", () => downloadBlob(res.blob, res.name));
        wrap.appendChild(dl);
      }

      const del = document.createElement("button");
      del.className = "dangerbtn";
      del.textContent = "Delete";
      del.addEventListener("click", () => deleteFile(idx));
      wrap.appendChild(del);

      tdAct.appendChild(wrap);

      tr.appendChild(tdName);
      tr.appendChild(tdOrig);
      tr.appendChild(tdRes);
      tr.appendChild(tdAct);
      tbody.appendChild(tr);
    });

    const okCount = state.results.filter(Boolean).length;
    $("downloadZip").disabled = okCount === 0;
  }

  function deleteFile(index){
    if (state.busy) return;

    state.files.splice(index, 1);
    state.results.splice(index, 1);

    if (state.files.length === 0){
      $("convert").disabled = true;
      $("downloadZip").disabled = true;
      $("clear").disabled = true;
      showProgress(false);
      setStatus("Ready.");
    } else {
      $("convert").disabled = false;
      $("clear").disabled = false;
      setStatus(`${state.files.length} file(s) selected.`);
    }
    renderTable();
  }

  // Dropzone
  const drop = $("drop");
  drop.addEventListener("click", () => $("file").click());
  drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.style.opacity = "0.85"; });
  drop.addEventListener("dragleave", () => { drop.style.opacity = "1"; });
  drop.addEventListener("drop", (e) => {
    e.preventDefault(); drop.style.opacity = "1";
    addFiles(Array.from(e.dataTransfer.files || []));
  });
  $("file").addEventListener("change", (e) => {
    addFiles(Array.from(e.target.files || []));
    $("file").value = "";
  });

  function addFiles(files){
    const images = files.filter(f => f && (f.type.startsWith("image/") || /\.(heic|heif)$/i.test(f.name)));
    if (!images.length){ setStatus("No image files detected."); return; }

    state.files.push(...images);
    state.results = new Array(state.files.length).fill(null);

    $("convert").disabled = false;
    $("clear").disabled = false;
    setStatus(`${state.files.length} file(s) selected.`);
    renderTable();
  }

  // Advanced toggle
  function setAdvanced(on){
    state.advanced = !!on;
    const sw = $("advSwitch");
    const adv = $("advanced");
    if (state.advanced){
      sw.classList.add("on");
      sw.setAttribute("aria-checked", "true");
      adv.classList.add("show");
    } else {
      sw.classList.remove("on");
      sw.setAttribute("aria-checked", "false");
      adv.classList.remove("show");
    }
  }

  $("advToggle").addEventListener("click", () => setAdvanced(!state.advanced));
  $("advSwitch").addEventListener("click", (e) => { e.stopPropagation(); setAdvanced(!state.advanced); });
  $("advSwitch").addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); setAdvanced(!state.advanced); }
  });

  $("quality").addEventListener("input", () => { $("qLabel").textContent = $("quality").value; });
  $("bg").addEventListener("change", () => { $("bgCustomWrap").style.display = $("bg").value === "custom" ? "block" : "none"; });

  // Resize mode -> enable/disable maxW/maxH (visible but greyed until Fit within)
  function syncResizeUI(){
    const fit = $("resizeMode").value === "fit";
    const maxBox = $("maxBox");
    const maxW = $("maxW");
    const maxH = $("maxH");

    maxW.disabled = !fit;
    maxH.disabled = !fit;

    if (fit){
      maxBox.classList.remove("disabledField");
    } else {
      maxBox.classList.add("disabledField");
      maxBox.classList.remove("show-help");
    }
  }
  $("resizeMode").addEventListener("change", syncResizeUI);

  // Worker
  function ensureWorker(){
    if (state.worker) return;

    const workerCode = `
      function calcFitSize(w, h, maxW, maxH){
        if (!maxW && !maxH) return { w, h };
        const mw = maxW || w;
        const mh = maxH || h;
        const scale = Math.min(1, mw / w, mh / h);
        return { w: Math.max(1, Math.round(w * scale)), h: Math.max(1, Math.round(h * scale)) };
      }

      async function jpegFromBitmap(bmp, outW, outH, bg, q){
        const canvas = new OffscreenCanvas(outW, outH);
        const ctx = canvas.getContext("2d", { alpha: false });
        ctx.fillStyle = bg;
        ctx.fillRect(0,0,outW,outH);
        ctx.drawImage(bmp, 0, 0, outW, outH);
        return await canvas.convertToBlob({ type: "image/jpeg", quality: q });
      }

      async function makeUnderTarget(bmp, outW, outH, bg, startQ, targetBytes){
        let q = startQ;
        let blob = await jpegFromBitmap(bmp, outW, outH, bg, q);
        if (!targetBytes) return { blob, q };

        const floor = 0.30;
        let attempts = 0;

        while (blob.size > targetBytes && q > floor && attempts < 12){
          const ratio = targetBytes / blob.size;
          const nextQ = Math.max(floor, Math.min(q - 0.05, q * (0.5 + 0.5 * ratio)));
          q = Number(nextQ.toFixed(3));
          blob = await jpegFromBitmap(bmp, outW, outH, bg, q);
          attempts++;
        }
        return { blob, q };
      }

      self.onmessage = async (ev) => {
        const msg = ev.data || {};
        if (msg.type !== "convert") return;

        const { files, settings } = msg;
        const total = files.length;
        let done = 0;

        if (typeof OffscreenCanvas === "undefined" || typeof createImageBitmap === "undefined"){
          self.postMessage({ type:"fatal", error:"Worker image processing not supported in this browser." });
          return;
        }

        for (let i=0; i<total; i++){
          const f = files[i];
          try{
            const blob = new Blob([f.data], { type: f.mime || "application/octet-stream" });
            const bmp = await createImageBitmap(blob);

            let outW = bmp.width, outH = bmp.height;
            if (settings.resizeMode === "fit"){
              const s = calcFitSize(bmp.width, bmp.height, settings.maxW, settings.maxH);
              outW = s.w; outH = s.h;
            }

            const { blob: outBlob } = await makeUnderTarget(
              bmp, outW, outH, settings.bg, settings.quality, settings.targetBytes
            );

            const ab = await outBlob.arrayBuffer();

            done++;
            self.postMessage({ type:"result", index:i, ok:true, name:f.outName, size:outBlob.size, data:ab }, [ab]);
            self.postMessage({ type:"progress", done, total });

          } catch (e){
            done++;
            self.postMessage({ type:"result", index:i, ok:false, error:String(e && e.message ? e.message : e) });
            self.postMessage({ type:"progress", done, total });
          }
        }

        self.postMessage({ type:"done" });
      };
    `;

    const blob = new Blob([workerCode], { type: "application/javascript" });
    const url = URL.createObjectURL(blob);
    state.worker = new Worker(url);
  }

  async function convertAll(){
    if (state.busy) return;
    if (!state.files.length) return;

    state.busy = true;
    $("convert").disabled = true;
    $("downloadZip").disabled = true;

    showProgress(true);
    setProgress(0, state.files.length);
    setStatus("Converting‚Ä¶ (worker)");

    state.results = new Array(state.files.length).fill(null);
    renderTable();

    const qualityPct = state.advanced ? Number($("quality").value) : 85;
    const nameMode = state.advanced ? $("nameMode").value : "keep";
    const bg = state.advanced ? bgColor() : "#ffffff";

    const settings = {
      quality: qualityPct / 100,
      resizeMode: $("resizeMode").value,
      maxW: Number($("maxW").value) || 0,
      maxH: Number($("maxH").value) || 0,
      bg: bg,
      targetBytes: (Number($("targetKB").value) > 0) ? Math.round(Number($("targetKB").value) * 1024) : 0
    };

    const payload = [];
    for (let i=0; i<state.files.length; i++){
      const f = state.files[i];
      const ab = await f.arrayBuffer();

      const base = safeBaseName(f.name);
      let outName = `${base}.jpg`;
      if (nameMode === "suffix") outName = `${base}-jpg.jpg`;
      if (nameMode === "alljpg") outName = `alljpg-${String(i+1).padStart(3,"0")}.jpg`;

      payload.push({ name:f.name, mime:f.type || "", outName, data: ab });
    }

    ensureWorker();
    const worker = state.worker;

    const onMessage = (ev) => {
      const m = ev.data || {};

      if (m.type === "fatal"){
        setStatus("Your browser does not support worker image processing. Try Chrome/Edge.");
        showProgress(false);
        state.busy = false;
        $("convert").disabled = false;
        worker.removeEventListener("message", onMessage);
        return;
      }

      if (m.type === "progress"){
        setProgress(m.done, m.total);
        setStatus(`Converting ${m.done}/${m.total}‚Ä¶`);
      }

      if (m.type === "result"){
        if (m.ok){
          const blob = new Blob([m.data], { type:"image/jpeg" });
          state.results[m.index] = { name:m.name, blob, size:m.size };
        } else {
          state.results[m.index] = null;
        }
        renderTable();
      }

      if (m.type === "done"){
        const okCount = state.results.filter(Boolean).length;
        setStatus(`Done. Converted ${okCount}/${state.files.length}.`);
        $("downloadZip").disabled = okCount === 0;
        $("convert").disabled = false;
        state.busy = false;
        worker.removeEventListener("message", onMessage);
      }
    };

    worker.addEventListener("message", onMessage);
    worker.postMessage({ type:"convert", files: payload, settings }, payload.map(x => x.data));
  }

  $("convert").addEventListener("click", convertAll);

  $("downloadZip").addEventListener("click", async () => {
    const ok = state.results.filter(Boolean);
    if (!ok.length) return;

    setStatus("Building ZIP‚Ä¶");
    $("downloadZip").disabled = true;

    const zip = new JSZip();
    ok.forEach(r => zip.file(r.name, r.blob));
    const blob = await zip.generateAsync({ type:"blob", compression:"DEFLATE", compressionOptions:{ level: 6 }});
    downloadBlob(blob, "alljpg-converted.zip");

    setStatus("ZIP downloaded.");
    $("downloadZip").disabled = false;
  });

  $("clear").addEventListener("click", () => {
    if (state.busy) return;
    state.files = [];
    state.results = [];
    $("convert").disabled = true;
    $("downloadZip").disabled = true;
    $("clear").disabled = true;
    setStatus("Ready.");
    showProgress(false);
    renderTable();
  });

  // init
  initHelp();
  setAdvanced(false);
  syncResizeUI();
  renderTable();
</script>
</body>
</html>
